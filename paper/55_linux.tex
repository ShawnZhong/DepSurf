\section{Linux Kernel Image Analysis}
\label{sec:linux}

\begin{table*}[t]
  \centering
  \setlength{\tabcolsep}{4.5pt}
  \small

  \newcommand{\chead}[2]{\multirow{#1}{*}{\rotatebox[origin=c]{90}{\bfseries #2}}}

  \newcommand{\ver}[4]{\multicolumn{1}{#1}{\multirow{2}{*}{\shortstack{#2 \\ #3 $\rightarrow$ #4}}}}
  \newcommand{\verl}[3]{\ver{c}{#1}{#2}{#3}}
  \newcommand{\verr}[3]{\ver{|c||}{#1}{#2}{#3}}

  \newcommand{\val}[2]{#1 (#2\%)}

  \begin{tabular}{c|l||rrrrr|r||l}
    % \newcommand{\mcol}[2]{\multicolumn{#1}{r||}{#2}}
    % \newcommand{\thead}[3]{\multicolumn{#1}{#2}{\bfseries #3}}
    %  & \thead{1}{r||}{}
    %  & \thead{5}{c|}{Ubuntu 20.04}
    %  & \thead{1}{c|}{Arch}
    %  & \thead{1}{c}{Error}
    % \\ \hline


     & \multirow{2}{*}{\bfseries Changes} & \verl{x86}{5.4}{5.8} & \verl{x86}{5.8}{5.11} & \verl{x86}{5.11}{5.13} & \verl{x86}{5.13}{5.15} & \verl{x86 Total}{5.4}{5.15} & \verr{Linux 5.8}{x86}{arm} & \multirow{2}{*}{\bfseries Error} \\
     &                                    &                      &                       &                        &                        &                             &                            &                                  \\ \hline\hline

    \chead{7}{Struct}
     & Added                              & \val{529}{ 6.3}      & \val{513}{ 5.9}       & \val{233}{ 2.6}        & \val{283}{ 3.1}        & \val{1426}{17.0}            & \val{1803}{20.7}           & Compile                          \\
     & Removed                            & \val{203}{ 2.4}      & \val{156}{ 1.8}       & \val{96}{ 1.1}         & \val{117}{ 1.3}        & \val{440}{ 5.2}             & \val{1033}{11.8}           & Compile                          \\
     & Changed                            & \val{973}{11.6}      & \val{771}{ 8.8}       & \val{476}{ 5.2}        & \val{656}{ 7.1}        & \val{1513}{18.0}            & \val{301}{ 3.5}            &                                  \\
     & - Field added                      & \val{485}{ 5.8}      & \val{439}{ 5.0}       & \val{272}{ 3.0}        & \val{365}{ 4.0}        & \val{944}{11.2}             & \val{29}{ 0.3}             & Compile                          \\
     & - Field removed                    & \val{315}{ 3.8}      & \val{232}{ 2.7}       & \val{154}{ 1.7}        & \val{163}{ 1.8}        & \val{533}{ 6.3}             & \val{35}{ 0.4}             & Compile                          \\
     & - Field type changed               & \val{219}{ 2.6}      & \val{164}{ 1.9}       & \val{111}{ 1.2}        & \val{140}{ 1.5}        & \val{400}{ 4.8}             & \val{37}{ 0.4}             & Silent                           \\
     & - Layout changed                   & \val{897}{10.7}      & \val{720}{ 8.3}       & \val{438}{ 4.8}        & \val{605}{ 6.6}        & \val{1408}{16.8}            & \val{294}{ 3.4}            &                                  \\
    \hline
    \chead{8}{Function}
     & Added                              & \val{3564}{ 7.4}     & \val{3080}{ 6.2}      & \val{1343}{ 2.6}       & \val{2121}{ 4.1}       & \val{8958}{18.6}            & \val{9936}{20.0}           & Runtime                          \\
     & Removed                            & \val{2000}{ 4.2}     & \val{1076}{ 2.2}      & \val{755}{ 1.5}        & \val{1123}{ 2.1}       & \val{3804}{ 7.9}            & \val{8031}{16.1}           & Runtime                          \\
     & Changed                            & \val{932}{ 1.9}      & \val{1176}{ 2.4}      & \val{549}{ 1.1}        & \val{640}{ 1.2}        & \val{2385}{ 5.0}            & \val{111}{ 0.2}            & Silent                           \\
     & - Param added                      & \val{535}{ 1.1}      & \val{375}{ 0.8}       & \val{428}{ 0.8}        & \val{298}{ 0.6}        & \val{1194}{ 2.5}            & \val{58}{ 0.1}             & Silent                           \\
     & - Param removed                    & \val{475}{ 1.0}      & \val{343}{ 0.7}       & \val{172}{ 0.3}        & \val{194}{ 0.4}        & \val{848}{ 1.8}             & \val{58}{ 0.1}             & Silent                           \\
     & - Param type changed               & \val{208}{ 0.4}      & \val{623}{ 1.3}       & \val{42}{ 0.1}         & \val{214}{ 0.4}        & \val{799}{ 1.7}             & \val{52}{ 0.1}             & Silent                           \\
     & - Param reordered                  & \val{132}{ 0.3}      & \val{163}{ 0.3}       & \val{280}{ 0.5}        & \val{104}{ 0.2}        & \val{544}{ 1.1}             & \val{2}{ 0.0}              & Silent                           \\
     & - Return type changed              & \val{130}{ 0.3}      & \val{82}{ 0.2}        & \val{51}{ 0.1}         & \val{111}{ 0.2}        & \val{276}{ 0.6}             & \val{7}{ 0.0}              & Silent                           \\
    \hline
    \chead{7}{Tracepoint Event}
     & Added                              & \val{51}{11.0}       & \val{31}{ 6.2}        & \val{13}{ 2.5}         & \val{17}{ 3.3}         & \val{94}{20.2}              & \val{49}{ 9.8}             & Compile                          \\
     & Removed                            & \val{16}{ 3.4}       & \val{6}{ 1.2}         & \val{15}{ 2.9}         & \val{15}{ 2.9}         & \val{34}{ 7.3}              & \val{56}{11.2}             & Compile                          \\
     & Changed                            & \val{36}{ 7.7}       & \val{14}{ 2.8}        & \val{10}{ 1.9}         & \val{17}{ 3.3}         & \val{47}{10.1}              & \val{0}{ 0.0}              &                                  \\
     & - Field added                      & \val{8}{ 1.7}        & \val{11}{ 2.2}        & \val{6}{ 1.1}          & \val{6}{ 1.1}          & \val{20}{ 4.3}              & \val{0}{ 0.0}              & Compile                          \\
     & - Field removed                    & \val{8}{ 1.7}        & \val{3}{ 0.6}         & \val{1}{ 0.2}          & \val{2}{ 0.4}          & \val{11}{ 2.4}              & \val{0}{ 0.0}              & Compile                          \\
     & - Field type changed               & \val{25}{ 5.4}       & \val{0}{ 0.0}         & \val{5}{ 1.0}          & \val{10}{ 1.9}         & \val{21}{ 4.5}              & \val{0}{ 0.0}              & Silent                           \\
     & - Layout changed                   & \val{31}{ 6.7}       & \val{14}{ 2.8}        & \val{9}{ 1.7}          & \val{14}{ 2.7}         & \val{43}{ 9.2}              & \val{0}{ 0.0}              &                                  \\
    \hline
    \chead{8}{LSM Hook}
     & Added                              & \val{10}{ 5.3}       & \val{1}{ 0.5}         & \val{5}{ 2.5}          & \val{0}{ 0.0}          & \val{16}{ 8.5}              & \val{0}{ 0.0}              & Runtime                          \\
     & Removed                            & \val{1}{ 0.5}        & \val{0}{ 0.0}         & \val{1}{ 0.5}          & \val{0}{ 0.0}          & \val{2}{ 1.1}               & \val{0}{ 0.0}              & Runtime                          \\
     & Changed                            & \val{18}{ 9.5}       & \val{5}{ 2.5}         & \val{4}{ 2.0}          & \val{5}{ 2.5}          & \val{23}{12.2}              & \val{0}{ 0.0}              & Silent                           \\
     & - Param added                      & \val{13}{ 6.9}       & \val{4}{ 2.0}         & \val{4}{ 2.0}          & \val{0}{ 0.0}          & \val{20}{10.6}              & \val{0}{ 0.0}              & Silent                           \\
     & - Param removed                    & \val{13}{ 6.9}       & \val{2}{ 1.0}         & \val{0}{ 0.0}          & \val{1}{ 0.5}          & \val{15}{ 7.9}              & \val{0}{ 0.0}              & Silent                           \\
     & - Param type changed               & \val{6}{ 3.2}        & \val{1}{ 0.5}         & \val{0}{ 0.0}          & \val{4}{ 2.0}          & \val{3}{ 1.6}               & \val{0}{ 0.0}              & Silent                           \\
     & - Param reordered                  & \val{0}{ 0.0}        & \val{0}{ 0.0}         & \val{4}{ 2.0}          & \val{0}{ 0.0}          & \val{4}{ 2.1}               & \val{0}{ 0.0}              & Silent                           \\
  \end{tabular}
  \caption{Linux kernel image changes for Ubuntu 20.04. }
  \label{tab:kernel_source_code_changes}
\end{table*}


In this section, we analyze the stability of eBPF programs
by examining the changes in the compiled Linux kernel image.
We compare the changes between different versions
and examine how the changes affect the eBPF programs.




\minisec{Methodology}
To understand the stability of eBPF programs, we examine the changes in the Linux kernel source code.
We use the popular Linux distribution, Ubuntu, and compare all Linux kernel versions officially supported by Ubuntu 20.04.
For x86 architecture, we compare the changes between Linux 5.4, 5.8, 5.11, 5.13, and 5.15.
To understand the differences in the ARM architecture, we use the Linux 5.8 kernel version.
For each kernel version, we download the package of the kernel image from the official Ubuntu repository,
extract the debug information from the image, and compare the changes.

\minisec{Result Overview}
The result of the comparison is summarized in Table~\ref{tab:kernel_source_code_changes}.
The table shows the changes in the Linux kernel source code for different kernel versions and architectures.
The ``Total'' column for kernel version upgrades shows the total number of changes between
the first and the last kernel version supported by Ubuntu 20.04.
It can also be seen as a distribution upgrade from Ubuntu 20.04 (Linux 5.4) to Ubuntu 22.04 (Linux 5.15).
We consider the changes for the following categories: struct, function, tracepoint event, and LSM hook.
For each category, we examine the number of added, removed, and changed items.
We also examine why the changes occur and how they affect the eBPF programs.
For all the results, we treat rename as one added and one removed item.


\minisec{Struct}
Kernel structs are used to define the data structure of the kernel,
and they are widely used in eBPF programs to access the kernel data.
Changes like struct added/removed or field added/removed result
in a compile error if the eBPF program depends on a particular version
of the struct or the field.
Filed type changes may result in a silent error because the eBPF program
can read the field and store the value in a different data type.
The compiler does not raise an error if the data type is compatible or a cast is used, but
the program may not work as expected.
Layout changes refer to any changes in the struct layout,
such as offset and size of the fields.
Such changes can be handled by CO-RE, or by compiling the eBPF program
on the target kernel version.

\minisec{Function}
eBPF programs can attach to kernel functions via kprobes and read the function arguments and return value.
For any changes in this category, the compiler would not diagnose any error.
When a userspace program tries to attach an eBPF program to a kernel function,
it will check if the function exists and raise an error if it does not.
So function added or removed will result in a runtime error if the eBPF program depends on the function.
If the function signature is changed, including the parameter added/removed, type changed, reordered, or return type changed,
then there would not be any direct error from the compiler or the verifier, since reading the function arguments and return value
boils down to reading the value from the register, and dereferencing the pointer stored.
Such changes would result in a silent error.

\minisec{Tracepoint Event}

\minisec{LSM Hook}

